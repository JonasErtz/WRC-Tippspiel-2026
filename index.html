<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>WRC Tippspiel 2026</title>
<style>
html, body {
  height: 100%;
  margin: 0;
  padding: 0;
}

body {
  font-family: Arial;
  max-width: 700px;
  margin: auto;
  text-align: center;
  color: black;
  position: relative; /* f√ºr Hintergrund */
}

h1, h2, h3 { color: black; }

#background {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(rgba(255,255,255,0.85), rgba(255,255,255,0.85)),
              url('images/deinBild.jpg') center/cover no-repeat;
  z-index: -1;
}

input, select, button {
  margin: 5px;
  padding: 8px;
  width: 95%;
}

h2 { margin-top: 30px; }
ul { text-align: left; }

.punkte-breakdown {
  font-size: 0.9em;
  color: #333;
  margin-left: 20px;
  white-space: pre-line;
}

.disabled { background-color: #ddd; }

.deadline-text {
  font-size: 0.85em;
  color: #666;
  margin-bottom: 10px;
}
</style>
</head>
<body>

<div id="background"></div>

<h1>üèÅ WRC Tippspiel 2026</h1>
<p>W√§hle eine Rallye und tippe!</p>

<select id="rallyeSelect"></select><br><br>

<div id="loginDiv">
  <input id="name" placeholder="Dein Name">
  <input id="password" type="password" placeholder="Passwort">
  <button id="loginButton">Anmelden / Registrieren</button>
  <button id="changePwButton">Passwort √§ndern</button>
</div>

<h3>Endplatzierungen (Pl√§tze 1‚Äì5)</h3>
<div class="deadline-text">
  <div id="deadlinePlatzFix"></div>
  <div id="deadlinePlatz"></div>
</div>
<select id="platz1"><option value="">Platz 1 w√§hlen</option></select>
<select id="platz2"><option value="">Platz 2 w√§hlen</option></select>
<select id="platz3"><option value="">Platz 3 w√§hlen</option></select>
<select id="platz4"><option value="">Platz 4 w√§hlen</option></select>
<select id="platz5"><option value="">Platz 5 w√§hlen</option></select>

<h3>Power Stage (Top 3)</h3>
<div class="deadline-text">
  <div id="deadlinePSFix"></div>
  <div id="deadlinePS"></div>
</div>
<select id="ps1"><option value="">PS Platz 1 w√§hlen</option></select>
<select id="ps2"><option value="">PS Platz 2 w√§hlen</option></select>
<select id="ps3"><option value="">PS Platz 3 w√§hlen</option></select>

<h3>Erster Ausfall</h3>
<div class="deadline-text">
  <div id="deadlineAusfallFix"></div>
  <div id="deadlineAusfall"></div>
</div>
<select id="ausfall"><option value="">Fahrer w√§hlen</option></select>

<button id="tipButton">Tipp abgeben</button>

<h2>üìä Rangliste (aktuelle Rallye)</h2>
<ul id="rangliste"></ul>

<h2>üèÜ Saison-Rangliste</h2>
<ul id="saisonRangliste"></ul>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
// ===================== FIREBASE =====================
firebase.initializeApp({
  apiKey: "AIzaSyBx6XHMMhlWpJgyeK7veKQ8i-fNVu4ohYU",
  authDomain: "wrc-tippspiel-2026.firebaseapp.com",
  databaseURL: "https://wrc-tippspiel-2026-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId: "wrc-tippspiel-2026",
  storageBucket: "wrc-tippspiel-2026.appspot.com",
  messagingSenderId: "342694581633",
  appId: "1:342694581633:web:133043efea71be6ddf8480"
});
const db = firebase.database();

// ===================== GLOBAL =====================
let currentUser = null;

// ===================== FAHRER =====================
const fahrer = ["Armstrong","Bertelli","Evans","Fourmaux","Katsuta","Lappi","McErlean","Munster","Neuville","Ogier","Paddon","Pajari","Sesks","Solberg","Sordo","-"];

// ===================== RALLYES =====================
const rallyes = [
{name:"bitte Rallye ausw√§hlen", rallyeStart: Date.UTC(2026,0,22,15,5,0), powerstageStart: Date.UTC(2026,0,22,15,5,0), endplatz: [], powerstage: [], ausfall: "", bgImage: "images/bild.jpg"},
{name:"Monte Carlo", rallyeStart: Date.UTC(2026,0,22,15,5,0), powerstageStart: Date.UTC(2026,0,25,12,15,0), endplatz: ["Solberg","Evans","Ogier","Fourmaux","Neuville"], powerstage: ["Evans","Solberg","Ogier"], ausfall: "McErlean", bgImage: "images/montecarlo.jpg"},
{name:"Schweden", rallyeStart: Date.UTC(2026,1,12,18,5,0), powerstageStart: Date.UTC(2026,1,15,11,15,0), endplatz: [], powerstage: [], ausfall: "", bgImage: "images/schweden.jpg"},
{name:"Kenia", rallyeStart: Date.UTC(2026,2,5,10,0,0), powerstageStart: Date.UTC(2026,2,8,15,0,0), endplatz: [], powerstage: [], ausfall: "", bgImage: "images/kenia.jpg"},
{name:"Kroatien", rallyeStart: Date.UTC(2026,3,2,10,0,0), powerstageStart: Date.UTC(2026,3,5,15,0,0), endplatz: [], powerstage: [], ausfall: "", bgImage: "images/kroatien.jpg"},
{name:"Gran Canaria", rallyeStart: Date.UTC(2026,3,16,10,0,0), powerstageStart: Date.UTC(2026,3,19,15,0,0), endplatz: [], powerstage: [], ausfall: "", bgImage: "images/grancanaria.jpg"},
{name:"Portugal", rallyeStart: Date.UTC(2026,4,7,10,0,0), powerstageStart: Date.UTC(2026,4,10,15,0,0), endplatz: [], powerstage: [], ausfall: "", bgImage: "images/portugal.jpg"},
{name:"Japan", rallyeStart: Date.UTC(2026,4,28,10,0,0), powerstageStart: Date.UTC(2026,4,31,15,0,0), endplatz: [], powerstage: [], ausfall: "", bgImage: "images/japan.jpg"},
{name:"Griechenland", rallyeStart: Date.UTC(2026,5,18,10,0,0), powerstageStart: Date.UTC(2026,5,21,15,0,0), endplatz: [], powerstage: [], ausfall: "", bgImage: "images/griechenland.jpg"},
{name:"Estland", rallyeStart: Date.UTC(2026,6,9,10,0,0), powerstageStart: Date.UTC(2026,6,12,15,0,0), endplatz: [], powerstage: [], ausfall: "", bgImage: "images/estland.jpg"},
{name:"Finnland", rallyeStart: Date.UTC(2026,6,30,10,0,0), powerstageStart: Date.UTC(2026,7,2,15,0,0), endplatz: [], powerstage: [], ausfall: "", bgImage: "images/finnland.jpg"},
{name:"Paraguay", rallyeStart: Date.UTC(2026,8,3,10,0,0), powerstageStart: Date.UTC(2026,8,6,15,0,0), endplatz: [], powerstage: [], ausfall: "", bgImage: "images/paraguay.jpg"},
{name:"Chile", rallyeStart: Date.UTC(2026,8,24,10,0,0), powerstageStart: Date.UTC(2026,8,27,15,0,0), endplatz: [], powerstage: [], ausfall: "", bgImage: "images/chile.jpg"},
{name:"Sardinien", rallyeStart: Date.UTC(2026,9,15,10,0,0), powerstageStart: Date.UTC(2026,9,18,15,0,0), endplatz: [], powerstage: [], ausfall: "", bgImage: "images/sardinien.jpg"},
{name:"Saudi Arabien", rallyeStart: Date.UTC(2026,10,5,10,0,0), powerstageStart: Date.UTC(2026,10,8,15,0,0), endplatz: [], powerstage: [], ausfall: "", bgImage: "images/saudiarabien.jpg"}
];

// ===================== PUNKTE LIVE BERECHNEN =====================
function berechnePunkte(tipp, rallye) {
  let punkte = 0;
  let breakdown = { platz: [], powerstage: [], ausfall: {} };

  tipp.platz.forEach((f,i)=>{
    let p = 0;
    if(f === rallye.endplatz[i]) p = (i===0)?7:5;
    else if(rallye.endplatz.includes(f)) p=2;
    breakdown.platz.push({fahrer:f,punkte:p});
    punkte += p;
  });

  tipp.powerstage.forEach((f,i)=>{
    let p = 0;
    if(f === rallye.powerstage[i]) p = (i===0)?4:3;
    else if(rallye.powerstage.includes(f)) p=2;
    breakdown.powerstage.push({fahrer:f,punkte:p});
    punkte += p;
  });

  let ausfallP = (tipp.ausfall === rallye.ausfall) ? 3 : 0;
  breakdown.ausfall = {fahrer:tipp.ausfall,punkte:ausfallP};
  punkte += ausfallP;

  return {punkte, breakdown};
}

// ===================== DROPDOWNS & EVENTLISTENER =====================
document.addEventListener("DOMContentLoaded", function(){
  ["platz1","platz2","platz3","platz4","platz5","ps1","ps2","ps3","ausfall"].forEach(id=>{
    const select = document.getElementById(id);
    fahrer.forEach(f=>{
      const o=document.createElement("option"); o.value=f; o.text=f;
      select.appendChild(o);
    });
  });

  const rallyeSelect = document.getElementById("rallyeSelect");
  rallyes.forEach((r,i)=>{
    const o=document.createElement("option"); o.value=i; o.text=r.name;
    rallyeSelect.appendChild(o);
  });

  document.getElementById("tipButton").addEventListener("click", function(){
    if(!currentUser){ alert("Bitte zuerst anmelden!"); return; }

    const tipps=["platz1","platz2","platz3","platz4","platz5"].map(id=>document.getElementById(id).value);
    const psTipps=["ps1","ps2","ps3"].map(id=>document.getElementById(id).value);
    const ausfallTipp=document.getElementById("ausfall").value;
    if(tipps.includes("") || psTipps.includes("") || !ausfallTipp){ alert("Bitte alle Felder ausf√ºllen!"); return; }

    // Tipps speichern OHNE Punkte
    const rallyeIndex = parseInt(rallyeSelect.value);
    db.ref('tipps/'+rallyeIndex+'/'+currentUser).set({
      platz: tipps,
      powerstage: psTipps,
      ausfall: ausfallTipp
    }).then(()=>ladeEigeneTipps());
  });

  rallyeSelect.addEventListener("change", function(){
    resetFields();
    if(currentUser) document.getElementById("name").value = currentUser;
    checkDeadline();
    tippsHolen();
    ladeEigeneTipps();
    updateBackground();
  });

  setInterval(() => {
    checkDeadline();
    updateCountdowns();
  }, 1000);
});

// ===================== TIPPS LADEN =====================
function ladeEigeneTipps(){
  const idx=parseInt(document.getElementById("rallyeSelect").value);
  if(!currentUser) return;

  db.ref("tipps/"+idx+"/"+currentUser).once("value").then(snap=>{
    const t=snap.val(); if(!t) return;
    ["platz1","platz2","platz3","platz4","platz5"].forEach((id,i)=>document.getElementById(id).value=t.platz[i]||"");
    ["ps1","ps2","ps3"].forEach((id,i)=>document.getElementById(id).value=t.powerstage[i]||"");
    document.getElementById("ausfall").value=t.ausfall||"";
  });
}

// ===================== RANGLISTE =====================
function tippsHolen(){
  const idx=parseInt(document.getElementById("rallyeSelect").value);
  db.ref('tipps/'+idx).on('value',snap=>{
    const daten=snap.val()||{};
    anzeigen(daten);
    anzeigenSaison();
  });
}

function anzeigen(daten){
  const liste = document.getElementById("rangliste");
  liste.innerHTML = "";
  const now = Date.now();
  const rallyeIndex = parseInt(document.getElementById("rallyeSelect").value);
  const rallye = rallyes[rallyeIndex];
  const ownName = document.getElementById("name").value.trim();

  Object.entries(daten)
  .sort((a,b)=>{
    const pa = berechnePunkte(a[1], rallye).punkte;
    const pb = berechnePunkte(b[1], rallye).punkte;
    return pb - pa;
  })
  .forEach(([name,val])=>{
    const showPlatz = now >= rallye.rallyeStart || name === ownName;
    const showPS = now >= rallye.powerstageStart || name === ownName;
    if(showPlatz){
      const {punkte: total, breakdown} = berechnePunkte(val, rallye);
      const li = document.createElement("li");
      li.innerHTML = `<strong>${name} ‚Äì ${total} Punkte</strong>`;
      const details = document.createElement("div");
      details.className = "punkte-breakdown";
      let text = "Pl√§tze:\n";
      breakdown.platz.forEach((p,i)=>{
        let color = p.punkte>=5?"green":(p.punkte>0?"orange":"red");
        let actual = rallye.endplatz[i]?` (tats√§chlich: ${rallye.endplatz[i]})`:"";
        text += ` ${i+1}. ${p.fahrer} ‚Üí <span style="color:${color}">${p.punkte} Punkte</span>${actual}\n`;
      });
      let ausfallP = breakdown.ausfall.punkte;
      let colorAusfall = ausfallP>0?"green":"red";
      let actualAusfall = rallye.ausfall?` (tats√§chlich: ${rallye.ausfall})`:"";
      text += `Erster Ausfall: ${breakdown.ausfall.fahrer} ‚Üí <span style="color:${colorAusfall}">${ausfallP} Punkte</span>${actualAusfall}\n`;
      if(showPS){
        text += "Power Stage:\n";
        breakdown.powerstage.forEach((p,i)=>{
          let color = p.punkte>=3?"green":(p.punkte>0?"orange":"red");
          let actual = rallye.powerstage[i]?` (tats√§chlich: ${rallye.powerstage[i]})`:"";
          text += ` ${i+1}. ${p.fahrer} ‚Üí <span style="color:${color}">${p.punkte} Punkte</span>${actual}\n`;
        });
      } else text += "Power Stage:\n ‚è≥ noch gesperrt\n";
      details.innerHTML = text;
      li.appendChild(details);
      liste.appendChild(li);
    }
  });
}

// ===================== SAISONRANGLISTE =====================
function anzeigenSaison(){
  const saisonListe = document.getElementById("saisonRangliste");
  saisonListe.innerHTML = "";

  const punkteMap = {};
  const rallyeMap = {};
  let ralliesProcessed = 0;

  rallyes.forEach((r,i)=>{
    db.ref('tipps/'+i).once('value').then(snap=>{
      const rDaten = snap.val() || {};
      Object.entries(rDaten).forEach(([name,val])=>{
        if(!punkteMap[name]) punkteMap[name] = 0;
        if(!rallyeMap[name]) rallyeMap[name] = [];

        const {punkte, breakdown} = berechnePunkte(val, rallyes[i]);
        punkteMap[name] += punkte;
        rallyeMap[name][i] = breakdown;
      });

      ralliesProcessed++;
      if(ralliesProcessed === rallyes.length){
        const sortedTeilnehmer = Object.entries(punkteMap).sort((a,b)=>b[1]-a[1]);
        sortedTeilnehmer.forEach(([name,total])=>{
          const li = document.createElement("li");
          li.innerHTML = `<strong>${name} ‚Äì ${total} Punkte</strong>`;
          const details = document.createElement("div");
          details.className = "punkte-breakdown";
          let html = "";
          rallyes