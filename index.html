<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>WRC Tippspiel 2026</title>
<style>
body { font-family: Arial; max-width: 700px; margin: auto; text-align: center; }
input, select, button { margin: 5px; padding: 8px; width: 95%; }
h2 { margin-top: 30px; }
ul { text-align: left; }
.punkte-breakdown { font-size: 0.9em; color: #333; margin-left: 20px; white-space: pre-line; }
.disabled { background-color: #ddd; }
</style>
</head>
<body>

<h1>üèÅ WRC Tippspiel 2026</h1>
<p>W√§hle eine Rallye und tippe!</p>

<select id="rallyeSelect"></select><br><br>
<input id="name" placeholder="Dein Name">

<h3>Endplatzierungen (Pl√§tze 1‚Äì5)</h3>
<select id="platz1"><option value="">Platz 1 w√§hlen</option></select>
<select id="platz2"><option value="">Platz 2 w√§hlen</option></select>
<select id="platz3"><option value="">Platz 3 w√§hlen</option></select>
<select id="platz4"><option value="">Platz 4 w√§hlen</option></select>
<select id="platz5"><option value="">Platz 5 w√§hlen</option></select>

<h3>Power Stage (Top 3)</h3>
<select id="ps1"><option value="">PS Platz 1 w√§hlen</option></select>
<select id="ps2"><option value="">PS Platz 2 w√§hlen</option></select>
<select id="ps3"><option value="">PS Platz 3 w√§hlen</option></select>

<h3>Erster Ausfall</h3>
<select id="ausfall"><option value="">Fahrer w√§hlen</option></select>

<button id="tipButton">Tipp abgeben</button>

<h2>üìä Rangliste (aktuelle Rallye)</h2>
<ul id="rangliste"></ul>

<h2>üèÜ Saison-Rangliste</h2>
<ul id="saisonRangliste"></ul>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
// ===================== ANMELDUNG =====================
let currentUser = localStorage.getItem("wrcName");

// ===================== FIREBASE =====================
firebase.initializeApp({
apiKey: "AIzaSyBx6XHMMhlWpJgyeK7veKQ8i-fNVu4ohYU",
authDomain: "wrc-tippspiel-2026.firebaseapp.com",
databaseURL: "https://wrc-tippspiel-2026-default-rtdb.europe-west1.firebasedatabase.app/",
projectId: "wrc-tippspiel-2026",
storageBucket: "wrc-tippspiel-2026.appspot.com",
messagingSenderId: "342694581633",
appId: "1:342694581633:web:133043efea71be6ddf8480"
});
const db = firebase.database();

// ===================== FAHRER =====================
const fahrer = ["Ogier","Evans","Neuville","Katsuta","Fourmaux","Pajari","Solberg","Munster","McErlean","Paddon","Armstrong","Sordo","Lappi","Sesks","Bertelli"];

// ===================== RALLYES =====================
const rallyes = [
{ name:"Monte Carlo", rallyeStart:Date.UTC(2026,0,22,10,0,0), powerstageStart:Date.UTC(2026,0,25,15,0,0), endplatz:[], powerstage:[], ausfall:"" },
{ name:"Schweden", rallyeStart:Date.UTC(2026,1,9,13,21,0), powerstageStart:Date.UTC(2026,1,9,13,25,0), endplatz:[], powerstage:[], ausfall:"" },
{ name:"Kenia", rallyeStart:Date.UTC(2026,1,9,14,2,0), powerstageStart:Date.UTC(2026,1,9,14,5,0), endplatz:["Ogier","Neuville","Evans","Katsuta","Solberg"], powerstage:[], ausfall:"Paddon" },
{ name:"Kroatien", rallyeStart:Date.UTC(2026,3,2,10,0,0), powerstageStart:Date.UTC(2026,3,5,15,0,0), endplatz:[], powerstage:[], ausfall:"" },
{ name:"Gran Canaria", rallyeStart:Date.UTC(2026,3,16,10,0,0), powerstageStart:Date.UTC(2026,3,19,15,0,0), endplatz:[], powerstage:[], ausfall:"" },
{ name:"Portugal", rallyeStart:Date.UTC(2026,4,7,10,0,0), powerstageStart:Date.UTC(2026,4,10,15,0,0), endplatz:[], powerstage:[], ausfall:"" },
{ name:"Japan", rallyeStart:Date.UTC(2026,4,28,10,0,0), powerstageStart:Date.UTC(2026,4,31,15,0,0), endplatz:[], powerstage:[], ausfall:"" },
{ name:"Griechenland", rallyeStart:Date.UTC(2026,5,18,10,0,0), powerstageStart:Date.UTC(2026,5,21,15,0,0), endplatz:[], powerstage:[], ausfall:"" },
{ name:"Estland", rallyeStart:Date.UTC(2026,6,9,10,0,0), powerstageStart:Date.UTC(2026,6,12,15,0,0), endplatz:[], powerstage:[], ausfall:"" },
{ name:"Finnland", rallyeStart:Date.UTC(2026,6,30,10,0,0), powerstageStart:Date.UTC(2026,7,2,15,0,0), endplatz:[], powerstage:[], ausfall:"" },
{ name:"Paraguay", rallyeStart:Date.UTC(2026,8,3,10,0,0), powerstageStart:Date.UTC(2026,8,6,15,0,0), endplatz:[], powerstage:[], ausfall:"" },
{ name:"Chile", rallyeStart:Date.UTC(2026,8,24,10,0,0), powerstageStart:Date.UTC(2026,8,27,15,0,0), endplatz:[], powerstage:[], ausfall:"" },
{ name:"Sardinien", rallyeStart:Date.UTC(2026,9,15,10,0,0), powerstageStart:Date.UTC(2026,9,18,15,0,0), endplatz:[], powerstage:[], ausfall:"" },
{ name:"Saudi Arabien", rallyeStart:Date.UTC(2026,10,5,10,0,0), powerstageStart:Date.UTC(2026,10,8,15,0,0), endplatz:[], powerstage:[], ausfall:"" }
];

// ===================== DROPDOWNS =====================
document.addEventListener("DOMContentLoaded", function(){
["platz1","platz2","platz3","platz4","platz5","ps1","ps2","ps3","ausfall"].forEach(id=>{
const select=document.getElementById(id);
fahrer.forEach(f=>{
const o=document.createElement("option");
o.value=f; o.text=f;
select.appendChild(o);
});
});

rallyes.forEach((r,i)=>{
const o=document.createElement("option");
o.value=i; o.text=r.name;
rallyeSelect.appendChild(o);
});

if(currentUser){
document.getElementById("name").value=currentUser;
document.getElementById("name").disabled=true;
ladeEigeneTipps();
}

rallyeSelect.addEventListener("change", function(){
resetFields();
if(currentUser) document.getElementById("name").value=currentUser;
checkDeadline();
tippsHolen();
ladeEigeneTipps();
});

document.getElementById("tipButton").addEventListener("click", function(){
let name=document.getElementById("name").value.trim();
if(!name) return alert("Bitte Name eingeben!");
if(!currentUser){
localStorage.setItem("wrcName", name);
currentUser=name;
document.getElementById("name").disabled=true;
}

const tipps=["platz1","platz2","platz3","platz4","platz5"].map(id=>document.getElementById(id).value);
const psTipps=["ps1","ps2","ps3"].map(id=>document.getElementById(id).value);
const ausfallTipp=document.getElementById("ausfall").value;
if(tipps.includes("") || psTipps.includes("") || !ausfallTipp){ alert("Bitte alle Felder ausf√ºllen!"); return; }

const rallye=rallyes[parseInt(rallyeSelect.value)];
let punkte=0; let breakdown={platz:[],powerstage:[],ausfall:0};
tipps.forEach((f,i)=>{ let p=0; if(f===rallye.endplatz[i]) p=(i===0)?7:5; else if(rallye.endplatz.includes(f)) p=2; breakdown.platz.push({fahrer:f,punkte:p}); punkte+=p; });
psTipps.forEach((f,i)=>{ let p=0; if(f===rallye.powerstage[i]) p=3; else if(rallye.powerstage.includes(f)) p=2; breakdown.powerstage.push({fahrer:f,punkte:p}); punkte+=p; });
let ausfallP=0; if(ausfallTipp===rallye.ausfall){ ausfallP=3; punkte+=3; } breakdown.ausfall={fahrer:ausfallTipp,punkte:ausfallP};

db.ref('tipps/'+parseInt(rallyeSelect.value)+'/'+name).set({punkte,breakdown}).then(()=>ladeEigeneTipps());
});

setInterval(checkDeadline,1000);
});

// ===================== Tipps laden =====================
function ladeEigeneTipps(){
const idx=parseInt(rallyeSelect.value);
if(!currentUser) return;

db.ref("tipps/"+idx+"/"+currentUser).once("value").then(snap=>{
const t=snap.val();
if(!t) return;

["platz1","platz2","platz3","platz4","platz5"].forEach((id,i)=>document.getElementById(id).value=t.breakdown.platz[i]?.fahrer||"");
["ps1","ps2","ps3"].forEach((id,i)=>document.getElementById(id).value=t.breakdown.powerstage[i]?.fahrer||"");
document.getElementById("ausfall").value=t.breakdown.ausfall?.fahrer||"";
});
}

// ===================== RANGLISTE =====================
function tippsHolen(){
const idx=parseInt(rallyeSelect.value);
db.ref('tipps/'+idx).on('value',snap=>{
const daten=snap.val()||{};
anzeigen(daten);
anzeigenSaison();
});
}

function anzeigen(daten){
const liste=document.getElementById("rangliste");
liste.innerHTML="";
const now=Date.now();
const rallyeIndex=parseInt(rallyeSelect.value);
const rallye=rallyes[rallyeIndex];
Object.entries(daten).forEach(([name,val])=>{
const showPlatz=now>=rallye.rallyeStart || name===currentUser;
const showPS=now>=rallye.powerstageStart || name===currentUser;
if(showPlatz){
const li=document.createElement("li");
li.textContent=`${name} ‚Äì ${val.punkte} Punkte`;
const details=document.createElement("div");
details.className="punkte-breakdown";
let text="Pl√§tze:\n"; val.breakdown.platz.forEach((p,i)=>{ text+=` ${i+1}. ${p.fahrer} ‚Üí ${p.punkte} Punkte\n`; });
text+="Erster Ausfall:\n"; text+=` ${val.breakdown.ausfall.fahrer} ‚Üí ${val.breakdown.ausfall.punkte} Punkte\n`;
if(showPS){ text+="Power Stage:\n"; val.breakdown.powerstage.forEach((p,i)=>{ text+=` ${i+1}. ${p.fahrer} ‚Üí ${p.punkte} Punkte\n`; }); }
else { text+="Power Stage:\n ‚è≥ noch gesperrt\n"; }
details.textContent=text;
li.appendChild(details);
liste.appendChild(li);
}
});
}

// ===================== RESET & DEADLINE =====================
function resetFields(){
["platz1","platz2","platz3","platz4","platz5","ps1","ps2","ps3","ausfall"].forEach(id=>{
document.getElementById(id).value="";
document.getElementById(id).disabled=false;
document.getElementById(id).className="";
});
if(!currentUser) document.getElementById("name").value="";
}

function checkDeadline(){
const now=Date.now(); const rallyeSelectVal=parseInt(rallyeSelect.value);
const rallye=rallyes[rallyeSelectVal];
const disablePlatz=now>=rallye.rallyeStart;
["platz1","platz2","platz3","platz4","platz5","ausfall"].forEach(id=>{
const elem=document.getElementById(id);
elem.disabled=disablePlatz;
elem.className=disablePlatz?"disabled":"";
});
const disablePS=now>=rallye.powerstageStart;
["ps1","ps2","ps3"].forEach(id=>{
const elem=document.getElementById(id);
elem.disabled=disablePS;
elem.className=disablePS?"disabled":"";
});
const tipButton=document.getElementById("tipButton");
tipButton.disabled=disablePlatz && disablePS;
tipButton.className=tipButton.disabled?"disabled":"";
}
</script>
</body>
</html>